name: ðŸ“¬ TÃ¤gliche Sicherungsbenachrichtigung

on:
  schedule:
    - cron: '10 4 * * *'
  workflow_dispatch:

jobs:
  send_mail:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¦ Installiere GitHub CLI + jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          type -p curl >/dev/null || (sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | \
            sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | \
            sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y

      - name: ðŸ” Analyse mit jq + gh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ“‹ Workflow Status:" > body.txt
          echo "" >> body.txt

          gh api repos/${{ github.repository }}/actions/runs --paginate -q '.workflow_runs[:5]' > runs.json

          COUNT=$(jq length runs.json)

          if [ "$COUNT" -eq 0 ]; then
            echo "âš ï¸ Keine Workflows gefunden." >> body.txt
          else
            for i in $(seq 0 $(($COUNT - 1))); do
              NAME=$(jq -r ".[$i].name" runs.json)
              STATUS=$(jq -r ".[$i].conclusion" runs.json)
              ID=$(jq -r ".[$i].workflow_id" runs.json)

              WF=$(gh api repos/${{ github.repository }}/actions/workflows/$ID)
              PATH=$(echo "$WF" | jq -r ".path")

              echo "- ðŸ›  $PATH â†’ $NAME: $STATUS" >> body.txt
            done
          fi

          echo "" >> body.txt
          echo "ðŸ‘‹ Freundliche GrÃ¼ÃŸe von deinem Backupbot ðŸš€" >> body.txt

      - name: ðŸ“¬ Sende E-Mail mit echtem Umbruch
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          subject: "[Backup-Status] - wind2horizon"
          to: gerhard@wind2horizon.com
          from: Wind2Horizon Backup <gerhard@wind2horizon.com>
          body: file://body.txt
