name: ðŸ“¬ TÃ¤gliche Sicherungsbenachrichtigung

on:
  schedule:
    - cron: '10 4 * * *'
  workflow_dispatch:

jobs:
  send_mail:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“‹ Erstelle body.txt mit Workflows (ohne jq)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ“‹ Workflow Status:" > body.txt
          echo "" >> body.txt

          curl -s -H "Authorization: token $GH_TOKEN" \
            https://api.github.com/repos/${{ github.repository }}/actions/runs?per_page=5 \
            > runs.json

          echo "" >> body.txt

          cat runs.json | grep '"name"\|"conclusion"\|"workflow_id"' | sed 's/[",]//g' | awk '
            /name:/ {name=$2}
            /conclusion:/ {status=$2}
            /workflow_id:/ {
              id=$2
              printf "- Workflow ID %s â†’ %s: %s\n", id, name, status
            }
          ' >> body.txt

          echo "" >> body.txt
          echo "ðŸ‘‹ Freundliche GrÃ¼ÃŸe von deinem Backupbot ðŸš€" >> body.txt

      - name: ðŸ“¬ Sende E-Mail mit echtem Umbruch
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          subject: "[Backup-Status] - wind2horizon"
          to: gerhard@wind2horizon.com
          from: Wind2Horizon Backup <gerhard@wind2horizon.com>
          body: file://body.txt
