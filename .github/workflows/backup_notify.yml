name: 📬 Tägliche Sicherungsbenachrichtigung

on:
  schedule:
    - cron: '10 4 * * *'  # 04:10 UTC = 06:10 MESZ
  workflow_dispatch:       # Manuell auslösbar für Testzwecke

jobs:
  send_mail:
    runs-on: ubuntu-latest
    steps:
      - name: 🔍 Letzte 5 GitHub-Workflows laden
        uses: actions/github-script@v6
        id: check
        with:
          script: |
            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 5
            });

            if (runs.workflow_runs.length === 0) {
              return "⚠️ Keine Workflows gefunden.";
            }

            const recent = runs.workflow_runs.slice(0, 5);
            const failed = recent.find(run => run.conclusion !== 'success');
            const details = recent.map(r => `${r.name}: ${r.conclusion}`).join('\n');

            return failed ? `❌ FEHLER\n\n${details}` : `✅ OK\n\n${details}`;

      - name: 📬 Sende E-Mail mit Ergebnis
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          subject: "[Backup-Status] - wind2horizon"
          to: gerhard@wind2horizon.com
          from: Wind2Horizon Backup <gerhard@wind2horizon.com>
          body: |
            Guten Morgen Gerhard! 😊

            Hier der aktuelle Status deiner GitHub-Workflows:

            ${{ steps.check.outputs.result }}

            Freundliche Grüße von deinem Backupbot 🚀
